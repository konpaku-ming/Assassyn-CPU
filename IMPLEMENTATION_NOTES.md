# 快速入门：BTB 和 DCache 修复

## 更改摘要

本 PR 修复了一个关键的 dcache 崩溃问题，并通过 BTB 实现了分支预测。

### 🐛 错误修复：DCache 索引越界
- **文件**: `src/execution.py`
- **问题**: 字节地址直接用作字索引 → 在索引 262120 处崩溃
- **修复**: 通过右移 2 位将字节地址转换为字索引

### 🚀 功能：分支目标缓冲器 (BTB)
- **文件**: `src/btb.py`（新文件）、`src/fetch.py`、`src/execution.py`、`src/main.py`
- **架构**: 直接映射，64 个条目，单周期预测
- **集成**: 取指阶段查询 BTB，执行阶段在分支时更新

## 测试

### 无需 Assassyn 容器（本地验证）
```bash
python3 /tmp/validate_fixes.py
```
这将验证地址和索引逻辑。

### 使用 Assassyn 容器（完整集成）
```bash
cd src
# 编辑 main.py 以选择工作负载:
# load_test_case("0to100")      # 或
# load_test_case("my0to100")

python3 main.py
```

预期结果：无崩溃，成功执行并记录 BTB 预测。

## 文档

参见 `docs/BTB_AND_DCACHE_FIX.md` 获取全面的文档，包括：
- 详细的问题分析
- BTB 架构和地址方案
- 集成点及代码示例
- 调试指南

## 验证清单

- [x] 已应用 DCache 地址修复
- [x] 已实现 BTB 模块
- [x] BTB 已集成到取指阶段
- [x] BTB 已集成到执行阶段
- [x] 顶层布线已完成
- [x] 逻辑已通过单元测试验证
- [x] 文档已创建
- [ ] 完整集成测试（需要 Assassyn 容器）

## 预期影响

1. **DCache 崩溃**: ✓ 已修复 - 地址已正确转换
2. **分支预测**: ✓ 已启用 - 单周期 BTB 预测
3. **0to100 工作负载**: 应该成功运行
4. **my0to100 工作负载**: 应该成功运行而不会崩溃
5. **性能**: 在分支密集型代码上有所改进（减少了预测错误的惩罚）
