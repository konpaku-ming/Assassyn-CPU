# RISC-V M Extension Implementation Architecture

## 修改概览 (Modification Overview)

```
┌─────────────────────────────────────────────────────────────────┐
│                     Assassyn-CPU Architecture                    │
│                        (5-Stage Pipeline)                        │
└─────────────────────────────────────────────────────────────────┘

┌───────┐    ┌───────┐    ┌───────┐    ┌───────┐    ┌───────┐
│  IF   │───▶│  ID   │───▶│  EX   │───▶│  MEM  │───▶│  WB   │
│ Fetch │    │Decode │    │Execute│    │Memory │    │Write  │
│       │    │       │    │       │    │Access │    │Back   │
└───────┘    └───┬───┘    └───┬───┘    └───────┘    └───────┘
                 │            │
                 │ Modified   │ Modified
                 │ Files:     │ Files:
                 │            │
                 ▼            ▼
        ┌─────────────┐  ┌─────────────┐
        │ decoder.py  │  │execution.py │
        │             │  │             │
        │ + funct7    │  │ + MUL ops   │
        │   parsing   │  │ + DIV ops   │
        │             │  │ + REM ops   │
        └──────┬──────┘  └──────┬──────┘
               │                │
               ▼                ▼
        ┌─────────────────────────────┐
        │   control_signals.py        │
        │                             │
        │   ALUOp: Bits(16) → Bits(32)│
        │   + 8 new opcodes           │
        └──────────────┬──────────────┘
                       │
                       ▼
        ┌─────────────────────────────┐
        │   instruction_table.py      │
        │                             │
        │   rv32i_table               │
        │   + 8 M-ext entries         │
        └─────────────────────────────┘
```

## M Extension 指令编码 (Instruction Encoding)

```
R-Type Format (所有 M-extension 指令):
┌─────────┬─────┬─────┬────────┬─────┬────────┬
│ funct7  │ rs2 │ rs1 │ funct3 │ rd  │ opcode │
│ [31:25] │[24:20]│[19:15]│[14:12]│[11:7]│[6:0] │
└─────────┴─────┴─────┴────────┴─────┴────────┘
    7        5     5      3       5       7

M Extension 特征:
- opcode  = 0110011 (OP_R_TYPE, 与 ADD/SUB 相同)
- funct7  = 0000001 (与基础指令的 0000000 区分)
- funct3  = 000~111 (区分 8 种操作)

指令映射:
funct3  │ 指令   │ 操作
────────┼────────┼──────────────────────────
  000   │ MUL    │ rd = (rs1 × rs2)[31:0]
  001   │ MULH   │ rd = (rs1 × rs2)[63:32] (signed×signed)
  010   │ MULHSU │ rd = (rs1 × rs2)[63:32] (signed×unsigned)
  011   │ MULHU  │ rd = (rs1 × rs2)[63:32] (unsigned×unsigned)
  100   │ DIV    │ rd = rs1 ÷ rs2 (signed)
  101   │ DIVU   │ rd = rs1 ÷ rs2 (unsigned)
  110   │ REM    │ rd = rs1 % rs2 (signed)
  111   │ REMU   │ rd = rs1 % rs2 (unsigned)
```

## 执行单元扩展 (Execution Unit Extension)

```
                      ┌─────────────────────┐
                      │   Decoder Output    │
                      │                     │
                      │  alu_func (Bits32)  │
                      │  rs1_data, rs2_data │
                      └──────────┬──────────┘
                                 │
                                 ▼
                      ┌─────────────────────┐
                      │  Operand Forwarding │
                      │                     │
                      │  Bypass: EX/MEM/WB  │
                      └──────────┬──────────┘
                                 │
                ┌────────────────┴────────────────┐
                │                                 │
                ▼                                 ▼
    ┌─────────────────────┐         ┌─────────────────────┐
    │  Existing ALU Ops   │         │   NEW: M-Ext Ops    │
    │                     │         │                     │
    │  • ADD   • SLL      │         │  • MUL   • DIV      │
    │  • SUB   • SLT      │         │  • MULH  • DIVU     │
    │  • AND   • SLTU     │         │  • MULHSU • REM     │
    │  • OR    • SRL      │         │  • MULHU  • REMU    │
    │  • XOR   • SRA      │         │                     │
    └─────────┬───────────┘         └─────────┬───────────┘
              │                               │
              └───────────────┬───────────────┘
                              │
                              ▼
                  ┌───────────────────────┐
                  │  Result Multiplexer   │
                  │                       │
                  │  select1hot(32 slots) │
                  └───────────┬───────────┘
                              │
                              ▼
                  ┌───────────────────────┐
                  │   Bypass Register     │
                  │   ex_bypass[0]        │
                  └───────────┬───────────┘
                              │
                              ▼
                  ┌───────────────────────┐
                  │   To MEM Stage        │
                  └───────────────────────┘
```

## 乘法实现细节 (Multiplication Implementation)

```
输入: rs1 (32-bit), rs2 (32-bit)
输出: rd (32-bit)

┌──────────────────────────────────────────────────────────┐
│                    Multiplier Unit                        │
├──────────────────────────────────────────────────────────┤
│                                                           │
│  rs1 (32-bit)              rs2 (32-bit)                  │
│      │                         │                          │
│      ├─── Sign Extend ─────────┤                          │
│      │                         │                          │
│      ▼                         ▼                          │
│   Int(32)                   Int(32)                      │
│      │                         │                          │
│      └──────────┬──────────────┘                          │
│                 │                                         │
│                 ▼                                         │
│          ┌────────────┐                                   │
│          │ 32×32 Mult │                                   │
│          │  Hardware  │                                   │
│          └──────┬─────┘                                   │
│                 │                                         │
│                 ▼                                         │
│            64-bit Result                                  │
│         ┌────────┴────────┐                               │
│         │                 │                               │
│         ▼                 ▼                               │
│    [63:32] High      [31:0] Low                          │
│         │                 │                               │
│    ┌────┴────┐       ┌────┴────┐                         │
│    │  MULH   │       │   MUL   │                         │
│    │ MULHSU  │       │         │                         │
│    │ MULHU   │       │         │                         │
│    └─────────┘       └─────────┘                         │
│                                                           │
└──────────────────────────────────────────────────────────┘

类型组合:
- MUL:    使用低 32 位 (任意类型)
- MULH:   Int(32) × Int(32) → 取高 32 位
- MULHSU: Int(32) × UInt(32) → 取高 32 位
- MULHU:  UInt(32) × UInt(32) → 取高 32 位
```

## 除法实现细节 (Division Implementation)

```
输入: rs1 (被除数), rs2 (除数)
输出: rd (商/余数)

┌──────────────────────────────────────────────────────────┐
│                    Divider Unit                           │
├──────────────────────────────────────────────────────────┤
│                                                           │
│  rs2 == 0?                                               │
│      │                                                    │
│      ├─── Yes ──▶ Special Case Handling                  │
│      │            • DIV:  return -1                       │
│      │            • DIVU: return 0xFFFFFFFF               │
│      │            • REM:  return rs1                      │
│      │            • REMU: return rs1                      │
│      │                                                    │
│      └─── No ───▶ Normal Division                        │
│                   │                                       │
│                   ▼                                       │
│          ┌────────────────┐                               │
│          │ Type Selection │                               │
│          └────────┬───────┘                               │
│                   │                                       │
│       ┌───────────┴───────────┐                           │
│       ▼                       ▼                           │
│   Signed (Int)           Unsigned (UInt)                  │
│       │                       │                           │
│       ▼                       ▼                           │
│  ┌─────────┐            ┌─────────┐                      │
│  │   DIV   │            │  DIVU   │                      │
│  │   REM   │            │  REMU   │                      │
│  └─────────┘            └─────────┘                      │
│                                                           │
│  特殊情况处理 (RISC-V Spec):                              │
│  • rs2 = 0:                                              │
│    - DIV/DIVU → -1 / 0xFFFFFFFF                          │
│    - REM/REMU → rs1                                      │
│  • Overflow (DIV only):                                  │
│    - rs1 = -2^31, rs2 = -1 → -2^31                       │
│                                                           │
└──────────────────────────────────────────────────────────┘

实现选项:
1. 单周期: 直接使用 Python `/` 和 `%` 运算符
   优点: 简单，延迟低
   缺点: 可能降低时钟频率

2. 多周期: 使用迭代算法（32 cycle）
   优点: 高时钟频率
   缺点: 需要 Stall 机制，复杂度高
```

## 测试策略 (Testing Strategy)

```
┌─────────────────────────────────────────────────────────┐
│                   Testing Pyramid                        │
├─────────────────────────────────────────────────────────┤
│                                                          │
│           ┌──────────────────────┐                      │
│           │  Integration Tests   │                      │
│           │  • Full CPU test     │                      │
│           │  • Assembly programs │                      │
│           └──────────┬───────────┘                      │
│                      │                                   │
│         ┌────────────┴────────────┐                     │
│         │    Module Tests         │                     │
│         │  • Execution unit       │                     │
│         │  • Decoder with funct7  │                     │
│         └────────┬────────────────┘                     │
│                  │                                       │
│    ┌─────────────┴─────────────┐                        │
│    │     Unit Tests            │                        │
│    │  • Individual M-ext inst  │                        │
│    │  • Edge cases             │                        │
│    │  • Divide by zero         │                        │
│    └───────────────────────────┘                        │
│                                                          │
└─────────────────────────────────────────────────────────┘

测试覆盖率目标:
✓ 基本功能: 所有 8 条指令
✓ 边界条件: 0, -1, MAX_INT, MIN_INT
✓ 特殊情况: 除零, 溢出 (0x80000000 ÷ -1)
✓ 组合测试: M-ext 与 RV32I 指令混合
✓ 性能测试: 与软件实现对比

测试用例示例:
• MUL:    10 × 20 = 200
• MUL:    -5 × 3 = -15
• MULH:   0x80000000 × 2 → 0x00000001 (high)
• DIV:    100 ÷ 10 = 10
• DIV:    10 ÷ 0 = -1 (special case)
• REM:    105 % 10 = 5
• REM:    10 % 0 = 10 (special case)
```

## 性能预期 (Performance Expectations)

```
┌─────────────────────────────────────────────────────────┐
│              Performance Comparison                      │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  Operation        │ Software  │ Hardware │ Speedup      │
│                   │ (cycles)  │ (cycles) │              │
│  ─────────────────┼───────────┼──────────┼──────────    │
│  Multiplication   │  ~100     │   1      │  100×        │
│  (32×32→32)       │           │          │              │
│  ─────────────────┼───────────┼──────────┼──────────    │
│  Division         │  ~200     │   1*     │  200×        │
│  (32÷32)          │           │  (32*)   │  (6×)        │
│  ─────────────────┼───────────┼──────────┼──────────    │
│                                                          │
│  * 单周期实现: 1 cycle (可能降低频率)                     │
│  * 多周期实现: 32 cycles (保持高频率)                     │
│                                                          │
│  实际测试程序 (workloads/multiply.exe):                  │
│  • 当前: 使用移位+加法实现乘法                            │
│  • 改进: 直接使用 MUL 指令                               │
│  • 预期: 指令数减少 90%+                                 │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

## 文件修改清单 (File Modification Checklist)

```
修改文件 (Modified Files):
├── src/
│   ├── control_signals.py      [修改] 扩展 ALUOp
│   ├── instruction_table.py    [修改] 添加 8 条指令
│   ├── decoder.py              [修改] 支持 funct7
│   └── execution.py            [修改] 实现乘除法
│
├── tests/
│   ├── test_m_extension.py     [新建] M-ext 单元测试
│   └── test_integration.py     [修改] 集成测试更新
│
├── workloads/
│   ├── mul_test.s              [新建] 乘法测试
│   ├── div_test.s              [新建] 除法测试
│   ├── mul_test.exe            [新建] 编译后的测试
│   └── div_test.exe            [新建] 编译后的测试
│
└── docs/
    ├── RV32M_Extension_Plan.md    [新建] 实施计划 (中文)
    ├── RV32M_Extension_Plan_EN.md [新建] 实施计划 (英文)
    ├── Module/
    │   ├── EX.md                  [修改] 更新执行单元文档
    │   └── ID.md                  [修改] 更新译码器文档
    └── RV32M_Extension_Guide.md   [新建] 使用指南

预计代码行数变化:
• 新增: ~800 行
• 修改: ~200 行
• 删除: ~0 行
```

## 风险矩阵 (Risk Matrix)

```
                  影响 (Impact)
                  高      中      低
              ┌──────┬──────┬──────┐
        高    │  🔴  │  🟡  │  🟢  │  除法器延迟
概率          ├──────┼──────┼──────┤
        中    │  🟡  │  🟡  │  🟢  │  资源消耗
              ├──────┼──────┼──────┤
        低    │  🟢  │  🟢  │  🟢  │  Assassyn限制
              └──────┴──────┴──────┘

风险应对:
🔴 高风险: 除法器延迟过大
   → 缓解策略: 采用多周期实现 + Stall

🟡 中风险: FPGA 资源不足
   → 缓解策略: 使用 DSP 原语, 资源复用

🟢 低风险: 框架不支持复杂运算
   → 缓解策略: 查阅文档, 联系开发者
```

---

**图表说明 (Diagram Notes)**:
- 所有图表使用 ASCII 字符绘制，兼容纯文本查看
- 流程图从上到下/从左到右表示数据流
- `│ ├ └ ┌ ┐ ┘ ┤ ┴ ┬` 用于绘制框架
- `▶ ▼ ◀ ▲` 表示数据流方向
- `✓ ✗` 表示完成状态
- `🔴 🟡 🟢` 表示风险等级（如不支持 emoji 请忽略）

**文档版本**: v1.0  
**创建日期**: 2025-12-24
