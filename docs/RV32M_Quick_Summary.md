# RISC-V M 扩展实施概要

## 📋 快速结论

**问题**: 能否将 Assassyn-CPU 从 RV32I 扩展到 RV32I-M？

**答案**: ✅ **完全可行！** 架构设计优秀，支持无缝集成。

**工作量**: 约 **1-2 个工作日**（8.5小时纯开发时间）

---

## 🎯 要添加的指令（8条）

| 类别 | 指令 | 功能 |
|------|------|------|
| 乘法 | MUL, MULH, MULHSU, MULHU | 32位乘法（返回低位/高位） |
| 除法 | DIV, DIVU | 有符号/无符号除法 |
| 取模 | REM, REMU | 有符号/无符号取余 |

---

## 🔧 需要修改的文件

1. **src/control_signals.py** ⏱️ 1小时
   - 扩展 `ALUOp` 从 Bits(16) 到 Bits(32)
   - 添加 8 个新的 ALU 操作码

2. **src/instruction_table.py** ⏱️ 0.5小时
   - 在 `rv32i_table` 中添加 8 条指令条目
   - 添加 `funct7` 字段支持

3. **src/decoder.py** ⏱️ 1小时
   - 提取完整的 `funct7` 字段（当前只有 bit30）
   - 添加 `funct7` 匹配逻辑

4. **src/execution.py** ⏱️ 2小时
   - 实现 4 种乘法运算（含类型转换）
   - 实现 4 种除法/取模运算（含除零处理）
   - 扩展 ALU 结果选择器

5. **tests/test_m_extension.py** ⏱️ 3小时（新建）
   - 单元测试（边界条件、除零等）
   - 集成测试（汇编程序）
   - 性能对比测试

6. **docs/** ⏱️ 1小时
   - 更新模块文档
   - 创建 M 扩展使用指南

---

## ✨ 为什么可行？

### ✅ 5大兼容性优势

1. **指令格式兼容** - M扩展使用R-Type，译码器已支持
2. **操作码空间充足** - ALUOp 还有空余位可用
3. **数据通路通用** - 与 ADD/SUB 完全相同的流向
4. **旁路机制复用** - 无需修改 Forwarding 逻辑
5. **流水线无影响** - 可视为单周期操作

### ⚠️ 3个需要注意的点

1. **运算复杂度** - 乘法器需要64位，除法器可能影响频率
2. **资源消耗** - 硬件乘除法器会增加逻辑资源
3. **除零处理** - 必须符合 RISC-V 规范（DIV(x,0)=-1, REM(x,0)=x）

---

## 📊 性能预期

| 操作 | 软件实现 | 硬件实现 | 提升倍数 |
|------|----------|----------|----------|
| 乘法 | ~100周期 | 1周期 | **100倍** |
| 除法 | ~200周期 | 1周期* | **200倍** |

*注: 除法可能采用多周期实现（32周期），此时提升约6倍

---

## 🚀 实施步骤（推荐顺序）

```
第1天上午（4小时）:
├─ 阶段一: 修改 control_signals.py（1h）
├─ 阶段二: 修改 instruction_table.py（0.5h）
├─ 阶段三: 修改 decoder.py（1h）
└─ 阶段四: 开始修改 execution.py（1.5h）

第1天下午（4.5小时）:
├─ 阶段四: 完成 execution.py（0.5h）
├─ 阶段五: 编写测试用例（3h）
└─ 阶段六: 更新文档（1h）
```

每个阶段完成后立即测试，确保增量开发的稳定性。

---

## 📚 详细文档

1. **docs/RV32M_Extension_Plan.md** - 完整的可行性分析（中文，100页+）
   - 详细的技术分析
   - 代码示例
   - 风险评估
   
2. **docs/RV32M_Extension_Plan_EN.md** - 英文版本

3. **docs/RV32M_Architecture_Diagram.md** - 可视化架构图
   - 流水线修改图
   - 指令编码图
   - 测试策略图

---

## 🧪 测试策略

```
测试金字塔:
    ┌─────────────┐
    │ 集成测试    │ ← 完整CPU测试、汇编程序
    ├─────────────┤
    │ 模块测试    │ ← 执行单元、译码器
    ├─────────────┤
    │ 单元测试    │ ← 单条指令、边界条件
    └─────────────┘
```

### 关键测试用例

```python
# 基础功能
MUL:    10 × 20 = 200
DIV:    100 ÷ 10 = 10
REM:    105 % 10 = 5

# 边界条件
MUL:    -5 × 3 = -15
MULH:   0x80000000 × 2 → 1 (高32位)

# 特殊情况
DIV:    10 ÷ 0 = -1  (除零)
REM:    10 % 0 = 10  (除零)
DIV:    0x80000000 ÷ -1 = 0x80000000 (溢出)
```

---

## 🎓 关键技术点

### 1. funct7 字段提取
```python
# 当前（只有 bit30）
bit30 = inst[30:30]

# 修改后（完整 funct7）
funct7 = inst[25:31]
```

### 2. 乘法实现（需类型转换）
```python
# MUL: 低32位
mul_res = (op1_signed * op2_signed).bitcast(Bits(64))[0:31]

# MULH: 高32位（有符号×有符号）
mulh_res = (op1_signed * op2_signed).bitcast(Bits(64))[32:63]
```

### 3. 除法特殊处理
```python
# 检测除零
is_div_zero = alu_op2 == Bits(32)(0)

# DIV: 除零返回 -1
div_res = is_div_zero.select(
    Bits(32)(0xFFFFFFFF),  # 除零
    (op1_signed / op2_signed).bitcast(Bits(32))  # 正常
)

# REM: 除零返回被除数
rem_res = is_div_zero.select(
    alu_op1,  # 除零
    (op1_signed % op2_signed).bitcast(Bits(32))  # 正常
)
```

---

## 🎯 成功标准

- [ ] 所有8条指令通过单元测试
- [ ] 除零处理符合RISC-V规范
- [ ] 与现有RV32I指令无冲突
- [ ] 旁路机制正常工作
- [ ] 性能提升达到预期（乘法10倍+，除法5倍+）
- [ ] 文档完整更新

---

## 💡 下一步建议

1. **审阅计划** - 仔细阅读 `docs/RV32M_Extension_Plan.md`
2. **确认资源** - 确保有足够的FPGA资源/仿真环境
3. **准备工具链** - 确认RISC-V编译器支持RV32IM
4. **开始实施** - 按照六个阶段逐步推进
5. **持续测试** - 每个阶段完成后立即回归测试

---

## 📞 参考资源

- **RISC-V规范**: [riscv.org](https://riscv.org/technical/specifications/)
- **RV32M章节**: Volume I, Chapter 7
- **Assassyn文档**: 项目内部 `docs/Assassyn.md`
- **现有测试**: `tests/test_execute_*.py` 可作为模板

---

## 🏆 预期收益

完成M扩展后，Assassyn-CPU将能够:

1. ✅ **运行标准RV32IM程序** - 兼容GCC `-march=rv32im`
2. ✅ **显著提升性能** - 乘除法运算提速10-200倍
3. ✅ **支持更多应用** - 密码学、图形学等需要乘除法的场景
4. ✅ **为后续扩展铺路** - F/D扩展（浮点）的基础

---

**文档版本**: v1.0  
**最后更新**: 2025-12-24  
**状态**: 📋 计划完成，等待实施
