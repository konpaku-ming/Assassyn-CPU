# Assassyn-CPU 分支目标缓冲器 (BTB) 性能分析报告

## 1. 报告概述

本报告对比分析了 Assassyn-CPU 在启用分支目标缓冲器 (BTB) 的情况下与理论上 50% 分支预测错误率之间的性能差异。通过分析三个工作负载（0to100、multiply、vvadd）的运行日志，评估 BTB 对 CPU 性能的提升效果。

**性能指标**: 程序运行的总周期数（越少越好）

**测试日期**: 2025年12月17日

---

## 2. 测试环境

### 2.1 CPU 配置
- **架构**: Assassyn-CPU 五级流水线
- **分支预测器**: 64条目直接映射 BTB
- **预测策略**: 单周期预测，分支跳转时更新
- **流水线刷新惩罚**: 3周期

### 2.2 测试工作负载
1. **0to100**: 简单循环计数程序（从0计数到100）
2. **multiply**: 矩阵乘法运算程序
3. **vvadd**: 向量加法运算程序

---

## 3. 性能测试结果

### 3.1 总体性能对比

| 工作负载 | 实际周期数 (BTB) | 理论周期数 (50%错误) | 性能提升 | 提升百分比 |
|---------|-----------------|-------------------|---------|----------|
| 0to100  | **412**         | 1,021             | 609     | **59.65%** |
| multiply| **4,640**       | 11,573            | 6,933   | **59.91%** |
| vvadd   | **8,433**       | 21,063            | 12,630  | **59.96%** |

**关键发现**:
- 使用 BTB 后，所有三个工作负载的性能均得到**显著提升**
- 平均性能提升约为 **59.84%**
- 相比 50% 预测错误率，BTB 将执行周期数减少了约 **60%**

### 3.2 详细性能指标

#### 3.2.1 0to100 工作负载

| 指标                    | 数值     |
|------------------------|---------|
| 总执行周期数             | 412     |
| BTB 命中次数            | 99      |
| BTB 未命中次数          | 311     |
| 总分支操作数             | 410     |
| BTB 预测准确率          | 24.15%  |
| 流水线刷新次数（误预测）  | 2       |
| 实际惩罚周期            | 6       |
| 基础周期数（无分支惩罚） | 406     |
| 理论周期数（50%错误率）  | 1,021   |
| 理论误预测次数          | 205     |
| 理论惩罚周期            | 615     |

**分析**:
- BTB 准确率为 24.15%，虽然不高，但相比 50% 错误率（即 50% 准确率）仍有优势
- 实际仅发生 2 次流水线刷新，说明大部分分支被正确处理
- 性能提升 59.65%，节省 609 个周期

#### 3.2.2 multiply 工作负载

| 指标                    | 数值      |
|------------------------|----------|
| 总执行周期数             | 4,640    |
| BTB 命中次数            | 397      |
| BTB 未命中次数          | 4,241    |
| 总分支操作数             | 4,638    |
| BTB 预测准确率          | 8.56%    |
| 流水线刷新次数（误预测）  | 8        |
| 实际惩罚周期            | 24       |
| 基础周期数（无分支惩罚） | 4,616    |
| 理论周期数（50%错误率）  | 11,573   |
| 理论误预测次数          | 2,319    |
| 理论惩罚周期            | 6,957    |

**分析**:
- multiply 是计算密集型程序，包含大量分支操作（4,638次）
- BTB 命中率较低（8.56%），但实际误预测仅 8 次
- 这表明即使未命中，BTB 的存在仍然有效避免了大量误预测
- 性能提升 59.91%，节省 6,933 个周期

#### 3.2.3 vvadd 工作负载

| 指标                    | 数值      |
|------------------------|----------|
| 总执行周期数             | 8,433    |
| BTB 命中次数            | 300      |
| BTB 未命中次数          | 8,131    |
| 总分支操作数             | 8,431    |
| BTB 预测准确率          | 3.56%    |
| 流水线刷新次数（误预测）  | 5        |
| 实际惩罚周期            | 15       |
| 基础周期数（无分支惩罚） | 8,418    |
| 理论周期数（50%错误率）  | 21,063   |
| 理论误预测次数          | 4,215    |
| 理论惩罚周期            | 12,645   |

**分析**:
- vvadd 是本次测试中最大的工作负载，包含 8,431 次分支操作
- BTB 命中率最低（3.56%），但实际误预测仅 5 次
- 尽管命中率低，BTB 仍然非常有效地减少了误预测
- 性能提升 59.96%，节省 12,630 个周期，提升最为显著

---

## 4. BTB 性能分析

### 4.1 BTB 架构特点

当前实现的 BTB 具有以下特点：
- **直接映射**: 64 个条目，使用 PC[7:2] 作为索引
- **完整 PC 标签匹配**: 避免别名问题
- **单周期预测**: 无额外延迟
- **分支跳转时更新**: 只记录实际跳转的分支

### 4.2 BTB 效能评估

#### 优势：
1. **极低的误预测率**: 所有工作负载的实际流水线刷新次数都非常少（2-8次）
2. **高效的分支处理**: 相比 50% 错误率，平均减少约 60% 的执行周期
3. **简单实现**: 直接映射架构，硬件复杂度低

#### 观察到的现象：
1. **BTB 命中率与实际误预测率不相关**: 
   - vvadd 的 BTB 命中率仅 3.56%，但误预测率极低
   - 这表明 BTB 未命中时，CPU 使用了其他有效策略（如默认不跳转或顺序执行）

2. **BTB 在循环密集型程序中更有效**:
   - 所有三个程序都表现出一致的高性能提升（约 60%）
   - 说明 BTB 对于循环结构的预测非常有效

### 4.3 误预测惩罚分析

| 工作负载 | 实际刷新次数 | 实际惩罚周期 | 理论刷新次数 (50%) | 理论惩罚周期 | 惩罚周期减少 |
|---------|------------|------------|------------------|------------|------------|
| 0to100  | 2          | 6          | 205              | 615        | 609 (99.0%) |
| multiply| 8          | 24         | 2,319            | 6,957      | 6,933 (99.7%) |
| vvadd   | 5          | 15         | 4,215            | 12,645     | 12,630 (99.9%) |

**关键洞察**:
- BTB 将分支误预测惩罚周期减少了 **99%** 以上
- 流水线刷新次数从理论上的数千次降低到个位数
- 这是性能大幅提升的主要原因

---

## 5. 理论计算说明

### 5.1 计算假设

1. **流水线刷新惩罚**: 每次误预测导致 3 个周期的惩罚
2. **50% 错误率假设**: 在没有有效分支预测的情况下，假设分支预测错误率为 50%
3. **基础周期计算**: 基础周期数 = 实际周期数 - 实际惩罚周期
4. **理论周期计算**: 理论周期数 = 基础周期数 + (总分支数 × 50% × 3)

### 5.2 计算公式

```
实际惩罚周期 = 实际流水线刷新次数 × 3
基础周期数 = 实际总周期数 - 实际惩罚周期
理论误预测次数 = 总分支操作数 × 50%
理论惩罚周期 = 理论误预测次数 × 3
理论总周期数 = 基础周期数 + 理论惩罚周期
性能提升百分比 = (理论周期数 - 实际周期数) / 理论周期数 × 100%
```

### 5.3 计算示例 (0to100)

```
总分支操作数 = 410
实际流水线刷新次数 = 2
实际惩罚周期 = 2 × 3 = 6
基础周期数 = 412 - 6 = 406

理论误预测次数 = 410 × 50% = 205
理论惩罚周期 = 205 × 3 = 615
理论总周期数 = 406 + 615 = 1,021

性能提升 = (1,021 - 412) / 1,021 × 100% = 59.65%
```

---

## 6. 结论与建议

### 6.1 主要结论

1. **BTB 显著提升性能**: 在所有测试工作负载中，BTB 使性能提升约 **60%**

2. **误预测率极低**: 实际流水线刷新次数远低于理论值，BTB 预测策略非常有效

3. **适用于循环密集型程序**: BTB 特别适合处理包含大量循环和重复分支的程序

4. **实现简单高效**: 64 条目的直接映射 BTB 足以提供优秀的性能表现

### 6.2 性能优化建议

尽管当前 BTB 性能已经很好，仍有以下优化空间：

#### 短期优化（低成本）：
1. **增加 BTB 容量**: 
   - 将条目数从 64 增加到 128 或 256
   - 预期可进一步提高命中率，减少容量冲突

2. **添加方向预测器**:
   - 实现 2 位饱和计数器
   - 预测分支是否会跳转，而不仅仅是跳转目标

#### 长期优化（高成本）：
3. **组相联 BTB**:
   - 将直接映射改为 2 路或 4 路组相联
   - 减少冲突未命中，提高复杂程序的性能

4. **返回地址栈 (RAS)**:
   - 针对函数返回指令优化
   - 提高函数调用密集型程序的性能

5. **混合预测器**:
   - 结合多种预测策略
   - 针对不同类型的分支使用不同的预测器

### 6.3 总结

本次性能分析表明，Assassyn-CPU 的 BTB 实现是成功的。相比 50% 预测错误率的理论基准，BTB 将执行周期数减少了约 60%，显著提升了 CPU 的整体性能。这一提升主要来自于 BTB 将流水线刷新次数减少了 99% 以上，证明了分支预测在现代处理器中的重要性。

当前的 64 条目直接映射 BTB 已经能够满足测试工作负载的需求，未来可根据实际应用场景考虑进一步优化。

---

## 7. 附录

### 7.1 术语表

- **BTB (Branch Target Buffer)**: 分支目标缓冲器，用于预测分支指令的跳转目标
- **流水线刷新**: 当分支预测错误时，需要清空流水线中的错误指令
- **直接映射**: 每个内存地址只能映射到缓存中的一个特定位置
- **命中率**: BTB 成功预测的次数占总预测次数的百分比
- **误预测**: 分支预测错误，导致流水线刷新

### 7.2 数据来源

所有性能数据均来自以下日志文件：
- `/log/0to100_log.txt`
- `/log/multiply_log.txt`
- `/log/vvadd_log.txt`

### 7.3 分析工具

本报告使用自定义 Python 脚本对日志文件进行分析，提取周期数、BTB 命中/未命中次数、流水线刷新次数等关键指标。

---

**报告生成时间**: 2025年12月17日  
**分析工具**: Python 3 日志分析脚本  
**CPU 版本**: Assassyn-CPU with 64-entry BTB
