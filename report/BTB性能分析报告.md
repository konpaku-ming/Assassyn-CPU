# Assassyn-CPU 分支目标缓冲器 (BTB) 性能分析报告

## 1. 报告概述

本报告对比分析了 Assassyn-CPU 在启用分支目标缓冲器 (BTB) 的情况下与理论上 50% 分支预测错误率之间的性能差异。通过分析三个工作负载（0to100、multiply、vvadd）的运行日志，评估 BTB 对 CPU 性能的提升效果。

**性能指标**: 程序运行的总周期数（越少越好）

---

## 2. 测试环境

### 2.1 CPU 配置
- **架构**: Assassyn-CPU 五级流水线
- **分支预测器**: 64条目直接映射 BTB
- **预测策略**: 单周期预测，分支跳转时更新
- **流水线刷新惩罚**: 3周期

### 2.2 测试工作负载
1. **0to100**: 简单循环计数程序（从0计数到100）
2. **multiply**: 矩阵乘法运算程序
3. **vvadd**: 向量加法运算程序

---

## 3. 性能测试结果

### 3.1 总体性能对比

| 工作负载 | 实际周期数 (BTB) | 理论周期数 (50%错误) | 性能提升 | 提升百分比 |
|---------|-----------------|-------------------|---------|----------|
| 0to100  | **412**         | 556               | 144     | **25.90%** |
| multiply| **4,640**       | 5,372             | 732     | **13.63%** |
| vvadd   | **8,433**       | 8,874             | 441     | **4.97%**  |

**关键发现**:
- 使用 BTB 后，所有三个工作负载的性能均得到**显著提升**
- 性能提升范围从 **5%** 到 **26%**，平均约为 **15%**
- BTB 在分支密集度较低的程序中效果更明显（如 0to100）

### 3.2 详细性能指标

#### 3.2.1 0to100 工作负载

| 指标                         | 数值     |
|-----------------------------|---------|
| 总执行周期数                  | 412     |
| BTB 命中次数                 | 99      |
| 总分支指令数                  | 100     |
| **BTB 命中率（分支指令）**    | **99.0%** |
| 流水线刷新次数（误预测）       | 2       |
| 实际惩罚周期                  | 6       |
| 基础周期数（无分支惩罚）       | 406     |
| 理论周期数（50%错误率）        | 556     |
| 理论误预测次数                | 50      |
| 理论惩罚周期                  | 150     |

**分析**:
- BTB 在分支指令上的命中率高达 **99.0%**，几乎所有分支都能被正确预测
- 实际仅发生 2 次流水线刷新，说明 BTB 预测非常准确
- 性能提升 25.90%，节省 144 个周期
- 注：BTB 对所有指令（包括非分支指令）都会记录 HIT/MISS，但我们关注的是分支指令的命中率

#### 3.2.2 multiply 工作负载

| 指标                         | 数值      |
|-----------------------------|----------|
| 总执行周期数                  | 4,640    |
| BTB 命中次数                 | 397      |
| 总分支指令数                  | 504      |
| **BTB 命中率（分支指令）**    | **78.77%** |
| 流水线刷新次数（误预测）       | 8        |
| 实际惩罚周期                  | 24       |
| 基础周期数（无分支惩罚）       | 4,616    |
| 理论周期数（50%错误率）        | 5,372    |
| 理论误预测次数                | 252      |
| 理论惩罚周期                  | 756      |

**分析**:
- multiply 是计算密集型程序，包含 504 条分支指令
- BTB 在分支指令上的命中率为 **78.77%**，表现良好
- 实际误预测仅 8 次，远低于理论值（252次）
- 性能提升 13.63%，节省 732 个周期
- 由于程序中非分支指令占比较高，BTB 的整体性能提升相对较小

#### 3.2.3 vvadd 工作负载

| 指标                         | 数值      |
|-----------------------------|----------|
| 总执行周期数                  | 8,433    |
| BTB 命中次数                 | 300      |
| 总分支指令数                  | 304      |
| **BTB 命中率（分支指令）**    | **98.68%** |
| 流水线刷新次数（误预测）       | 5        |
| 实际惩罚周期                  | 15       |
| 基础周期数（无分支惩罚）       | 8,418    |
| 理论周期数（50%错误率）        | 8,874    |
| 理论误预测次数                | 152      |
| 理论惩罚周期                  | 456      |

**分析**:
- vvadd 是本次测试中最大的工作负载，但分支指令仅 304 条
- BTB 在分支指令上的命中率高达 **98.68%**，几乎完美
- 实际误预测仅 5 次，远低于理论值（152次）
- 性能提升 4.97%，节省 441 个周期
- 由于程序中分支指令占比极低（304/8431），BTB 的整体性能提升有限

---

## 4. BTB 性能分析

### 4.1 BTB 架构特点

当前实现的 BTB 具有以下特点：
- **直接映射**: 64 个条目，使用 PC[7:2] 作为索引
- **完整 PC 标签匹配**: 避免别名问题
- **单周期预测**: 无额外延迟
- **分支跳转时更新**: 只记录实际跳转的分支

### 4.2 BTB 效能评估

#### 优势：
1. **极高的分支预测命中率**: 对于分支指令，BTB 命中率在 78.77% 到 99% 之间
2. **极低的误预测率**: 所有工作负载的实际流水线刷新次数都非常少（2-8次）
3. **有效的性能提升**: 相比 50% 错误率，性能提升从 5% 到 26%
4. **简单实现**: 直接映射架构，硬件复杂度低

#### 观察到的现象：
1. **BTB 对分支指令的命中率很高**: 
   - 0to100: 99.0% 命中率
   - multiply: 78.77% 命中率
   - vvadd: 98.68% 命中率
   - 说明 BTB 能够有效记录和预测循环分支

2. **性能提升与分支指令密度相关**:
   - 0to100（100分支/412周期）性能提升 25.90%
   - multiply（504分支/4640周期）性能提升 13.63%
   - vvadd（304分支/8433周期）性能提升 4.97%
   - 分支指令占比越高，BTB 的性能提升越显著

3. **BTB 在循环密集型程序中表现优异**:
   - 循环分支由于地址重复，容易被 BTB 记录和预测
   - 0to100 和 vvadd 都是简单循环程序，BTB 命中率接近 99%

### 4.3 误预测惩罚分析

| 工作负载 | 实际刷新次数 | 实际惩罚周期 | 理论刷新次数 (50%) | 理论惩罚周期 | 惩罚周期减少 |
|---------|------------|------------|------------------|------------|------------|
| 0to100  | 2          | 6          | 50               | 150        | 144 (96.0%) |
| multiply| 8          | 24         | 252              | 756        | 732 (96.8%) |
| vvadd   | 5          | 15         | 152              | 456        | 441 (96.7%) |

**关键洞察**:
- BTB 将分支误预测惩罚周期减少了 **96%** 以上
- 流水线刷新次数从理论上的数十至数百次降低到个位数
- 这是性能提升的主要原因

---

## 5. 理论计算说明

### 5.1 计算假设

1. **流水线刷新惩罚**: 每次误预测导致 3 个周期的惩罚
2. **50% 错误率假设**: 在没有有效分支预测的情况下，假设分支预测错误率为 50%
3. **基础周期计算**: 基础周期数 = 实际周期数 - 实际惩罚周期
4. **理论周期计算**: 理论周期数 = 基础周期数 + (实际分支指令数 × 50% × 3)
5. **重要说明**: 统计时关注的是**命中 BTB 的分支指令占总分支指令的比例**，而不是 BTB 在所有指令上的命中率

### 5.2 计算公式

```
实际惩罚周期 = 实际流水线刷新次数 × 3
基础周期数 = 实际总周期数 - 实际惩罚周期
理论误预测次数 = 实际分支指令数 × 50%
理论惩罚周期 = 理论误预测次数 × 3
理论总周期数 = 基础周期数 + 理论惩罚周期
性能提升百分比 = (理论周期数 - 实际周期数) / 理论周期数 × 100%
BTB命中率（分支指令）= BTB命中次数 / 实际分支指令数 × 100%
```

**注意**: 
- `实际分支指令数` 是指执行阶段识别出的真实分支指令（不包括 NO_BRANCH）
- `BTB命中次数` 是指取指阶段 BTB 预测命中的次数
- BTB 会对所有指令进行预测（HIT/MISS），但我们只关注分支指令的命中率

### 5.3 计算示例 (0to100)

```
实际分支指令数 = 100  （从日志中统计非 NO_BRANCH 的指令）
BTB 命中次数 = 99
BTB 命中率（分支指令）= 99 / 100 × 100% = 99.0%

实际流水线刷新次数 = 2
实际惩罚周期 = 2 × 3 = 6
基础周期数 = 412 - 6 = 406

理论误预测次数 = 100 × 50% = 50
理论惩罚周期 = 50 × 3 = 150
理论总周期数 = 406 + 150 = 556

性能提升 = (556 - 412) / 556 × 100% = 25.90%
```

---

## 6. 结论与建议

1. **BTB 对分支指令的预测非常准确**: 在分支指令上的命中率范围从 **78.77%** 到 **99%**

2. **整体性能提升显著**: 根据工作负载特点，性能提升从 **5%** 到 **26%** 不等

3. **误预测率极低**: 实际流水线刷新次数远低于理论值，BTB 预测策略非常有效

4. **适用于循环密集型程序**: BTB 特别适合处理包含大量循环和重复分支的程序
   - 简单循环程序（0to100, vvadd）命中率接近 99%
   - 复杂计算程序（multiply）命中率也达到 78.77%

5. **性能提升与分支密度相关**: 分支指令在程序中占比越高，BTB 的性能提升越明显

6. **实现简单高效**: 64 条目的直接映射 BTB 足以提供优秀的性能表现

### 6.3 总结

本次性能分析表明，Assassyn-CPU 的 BTB 实现是成功的。相比 50% 预测错误率的理论基准，BTB 在分支指令上实现了 **78.77% 到 99%** 的高命中率，将流水线刷新次数减少了 96% 以上，显著提升了 CPU 的整体性能（5% 到 26%）。

**关键发现**：
- BTB 对循环分支的预测几乎完美（99%命中率）
- 性能提升与程序中分支指令的占比直接相关
- 即使是复杂的计算程序（multiply），BTB 也能达到近 80% 的命中率

**修正说明**：
- 本报告统计的是**命中 BTB 的分支指令占总分支指令的比例**
- 之前的统计错误地将 BTB 在所有指令上的命中情况作为指标
- 修正后的数据更准确地反映了 BTB 在分支预测中的实际效果

当前的 64 条目直接映射 BTB 已经能够满足测试工作负载的需求，未来可根据实际应用场景考虑进一步优化。
