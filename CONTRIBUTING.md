# è´¡çŒ®æŒ‡å—

æ„Ÿè°¢æ‚¨å¯¹ Assassyn-CPU é¡¹ç›®çš„å…³æ³¨ï¼æˆ‘ä»¬æ¬¢è¿ä»»ä½•å½¢å¼çš„è´¡çŒ®ã€‚

## ç›®å½•

- [è¡Œä¸ºå‡†åˆ™](#è¡Œä¸ºå‡†åˆ™)
- [å¦‚ä½•è´¡çŒ®](#å¦‚ä½•è´¡çŒ®)
- [å¼€å‘æµç¨‹](#å¼€å‘æµç¨‹)
- [ä»£ç è§„èŒƒ](#ä»£ç è§„èŒƒ)
- [æäº¤è§„èŒƒ](#æäº¤è§„èŒƒ)
- [æµ‹è¯•è¦æ±‚](#æµ‹è¯•è¦æ±‚)
- [æ–‡æ¡£è´¡çŒ®](#æ–‡æ¡£è´¡çŒ®)
- [é—®é¢˜æŠ¥å‘Š](#é—®é¢˜æŠ¥å‘Š)

## è¡Œä¸ºå‡†åˆ™

### æˆ‘ä»¬çš„æ‰¿è¯º

ä¸ºäº†è¥é€ ä¸€ä¸ªå¼€æ”¾å’Œå‹å¥½çš„ç¯å¢ƒï¼Œæˆ‘ä»¬æ‰¿è¯ºè®©æ‰€æœ‰äººéƒ½èƒ½è‡ªç”±åœ°å‚ä¸åˆ°æœ¬é¡¹ç›®ä¸­ï¼Œæ— è®ºå…¶ç»éªŒæ°´å¹³ã€æ€§åˆ«ã€æ€§åˆ«è®¤åŒå’Œè¡¨è¾¾ã€æ€§å–å‘ã€æ®‹ç–¾ã€å¤–è²Œã€ä½“å‹ã€ç§æ—ã€å¹´é¾„æˆ–å®—æ•™ä¿¡ä»°ã€‚

### æˆ‘ä»¬çš„æ ‡å‡†

**ç§¯æè¡Œä¸ºåŒ…æ‹¬**:
- ä½¿ç”¨å‹å¥½å’ŒåŒ…å®¹çš„è¯­è¨€
- å°Šé‡ä¸åŒçš„è§‚ç‚¹å’Œç»éªŒ
- ä¼˜é›…åœ°æ¥å—å»ºè®¾æ€§æ‰¹è¯„
- å…³æ³¨å¯¹ç¤¾åŒºæœ€æœ‰åˆ©çš„äº‹æƒ…
- å¯¹å…¶ä»–ç¤¾åŒºæˆå‘˜è¡¨ç¤ºåŒç†å¿ƒ

**ä¸å¯æ¥å—çš„è¡Œä¸ºåŒ…æ‹¬**:
- ä½¿ç”¨æ€§åŒ–çš„è¯­è¨€æˆ–å›¾åƒï¼Œä»¥åŠä¸å—æ¬¢è¿çš„æ€§å…³æ³¨æˆ–ç¤ºå¥½
- æŒ‘è¡…ã€ä¾®è¾±/è´¬æŸæ€§è¯„è®ºï¼Œä»¥åŠäººèº«æˆ–æ”¿æ²»æ”»å‡»
- å…¬å¼€æˆ–ç§ä¸‹éªšæ‰°
- æœªç»æ˜ç¡®è®¸å¯ï¼Œå‘å¸ƒä»–äººçš„ç§äººä¿¡æ¯ï¼Œå¦‚ç‰©ç†æˆ–ç”µå­åœ°å€
- å…¶ä»–åœ¨ä¸“ä¸šç¯å¢ƒä¸­å¯ä»¥åˆç†è®¤ä¸ºä¸é€‚å½“çš„è¡Œä¸º

## å¦‚ä½•è´¡çŒ®

### è´¡çŒ®ç±»å‹

æˆ‘ä»¬æ¬¢è¿ä»¥ä¸‹ç±»å‹çš„è´¡çŒ®ï¼š

1. **ä»£ç è´¡çŒ®**
   - æ–°åŠŸèƒ½å®ç°
   - Bug ä¿®å¤
   - æ€§èƒ½ä¼˜åŒ–
   - ä»£ç é‡æ„

2. **æ–‡æ¡£è´¡çŒ®**
   - æ”¹è¿›ç°æœ‰æ–‡æ¡£
   - æ·»åŠ æ–°çš„æ•™ç¨‹æˆ–æŒ‡å—
   - ç¿»è¯‘æ–‡æ¡£
   - ä¿®æ­£æ‹¼å†™æˆ–è¯­æ³•é”™è¯¯

3. **æµ‹è¯•è´¡çŒ®**
   - æ·»åŠ æ–°çš„æµ‹è¯•ç”¨ä¾‹
   - æ”¹è¿›æµ‹è¯•è¦†ç›–ç‡
   - ä¿®å¤å¤±è´¥çš„æµ‹è¯•

4. **é—®é¢˜æŠ¥å‘Š**
   - Bug æŠ¥å‘Š
   - åŠŸèƒ½è¯·æ±‚
   - æ€§èƒ½é—®é¢˜

5. **è®¾è®¡è´¡çŒ®**
   - æ¶æ„è®¾è®¡å»ºè®®
   - æ¥å£è®¾è®¡æ”¹è¿›
   - æ–‡æ¡£å›¾è¡¨åˆ¶ä½œ

## å¼€å‘æµç¨‹

### 1. Fork ä»“åº“

```bash
# åœ¨ GitHub ä¸Šç‚¹å‡» Fork æŒ‰é’®
# ç„¶åå…‹éš†æ‚¨çš„ fork
git clone https://github.com/YOUR_USERNAME/Assassyn-CPU.git
cd Assassyn-CPU

# æ·»åŠ ä¸Šæ¸¸ä»“åº“
git remote add upstream https://github.com/konpaku-ming/Assassyn-CPU.git
```

### 2. åˆ›å»ºå¼€å‘åˆ†æ”¯

```bash
# æ›´æ–°ä¸»åˆ†æ”¯
git checkout main
git pull upstream main

# åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
git checkout -b feature/your-feature-name

# æˆ–è€…ä¿®å¤åˆ†æ”¯
git checkout -b fix/bug-description
```

åˆ†æ”¯å‘½åè§„èŒƒï¼š
- `feature/xxx` - æ–°åŠŸèƒ½
- `fix/xxx` - Bug ä¿®å¤
- `docs/xxx` - æ–‡æ¡£æ›´æ–°
- `refactor/xxx` - ä»£ç é‡æ„
- `test/xxx` - æµ‹è¯•ç›¸å…³

### 3. è®¾ç½®å¼€å‘ç¯å¢ƒ

```bash
# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python3 -m venv .venv
source .venv/bin/activate  # Linux/macOS
# æˆ–
.\.venv\Scripts\Activate.ps1  # Windows

# å®‰è£…ä¾èµ–ï¼ˆåŒ…æ‹¬å¼€å‘ä¾èµ–ï¼‰
pip install -r requirements.txt

# å®‰è£…ä»£ç æ£€æŸ¥å·¥å…·
pip install black flake8 mypy pytest-cov
```

### 4. è¿›è¡Œæ›´æ”¹

- éµå¾ª[ä»£ç è§„èŒƒ](#ä»£ç è§„èŒƒ)
- ç¼–å†™æ¸…æ™°çš„ä»£ç æ³¨é‡Š
- ä¸ºæ–°åŠŸèƒ½æ·»åŠ æµ‹è¯•
- æ›´æ–°ç›¸å…³æ–‡æ¡£

### 5. è¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
make test

# è¿è¡Œç‰¹å®šæµ‹è¯•
make test-fetch
make test-decoder

# æ£€æŸ¥æµ‹è¯•è¦†ç›–ç‡
pytest tests/ --cov=src --cov-report=html
```

### 6. ä»£ç è´¨é‡æ£€æŸ¥

```bash
# æ ¼å¼åŒ–ä»£ç 
make format

# è¿è¡Œ linter
make lint

# ç±»å‹æ£€æŸ¥
make typecheck
```

### 7. æäº¤æ›´æ”¹

```bash
# æ·»åŠ æ›´æ”¹
git add .

# æäº¤ï¼ˆéµå¾ªæäº¤è§„èŒƒï¼‰
git commit -m "feat: add new feature"

# æ¨é€åˆ°æ‚¨çš„ fork
git push origin feature/your-feature-name
```

### 8. åˆ›å»º Pull Request

1. è®¿é—®æ‚¨çš„ fork åœ¨ GitHub ä¸Šçš„é¡µé¢
2. ç‚¹å‡» "New Pull Request"
3. é€‰æ‹©æ‚¨çš„åŠŸèƒ½åˆ†æ”¯
4. å¡«å†™ PR æ¨¡æ¿ï¼ˆè§ä¸‹æ–‡ï¼‰
5. æäº¤ Pull Request

## ä»£ç è§„èŒƒ

### Python ä»£ç è§„èŒƒ

æˆ‘ä»¬éµå¾ª [PEP 8](https://www.python.org/dev/peps/pep-0008/) é£æ ¼æŒ‡å—ï¼Œå¹¶æœ‰ä»¥ä¸‹é¢å¤–è¦æ±‚ï¼š

#### 1. æ ¼å¼åŒ–

ä½¿ç”¨ `black` è¿›è¡Œè‡ªåŠ¨æ ¼å¼åŒ–ï¼š

```bash
black src/ tests/
```

#### 2. å‘½åè§„èŒƒ

```python
# æ¨¡å—åï¼šå°å†™å­—æ¯ï¼Œä¸‹åˆ’çº¿åˆ†éš”
# æ–‡ä»¶å: decoder.py, data_hazard.py

# ç±»åï¼šå¤§é©¼å³°ï¼ˆPascalCaseï¼‰
class Decoder(Module):
    pass

class DataHazardUnit(Module):
    pass

# å‡½æ•°åï¼šå°å†™å­—æ¯ï¼Œä¸‹åˆ’çº¿åˆ†éš”
def get_pad(width, hex_mask, sign):
    pass

# å¸¸é‡ï¼šå¤§å†™å­—æ¯ï¼Œä¸‹åˆ’çº¿åˆ†éš”
ALU_OP_ADD = 0b0000
MEM_OP_LOAD = 0b01

# å˜é‡åï¼šå°å†™å­—æ¯ï¼Œä¸‹åˆ’çº¿åˆ†éš”
pc_reg = RegArray(Bits(32), 1)
branch_target = Bits(32)(0)
```

#### 3. æ³¨é‡Šè§„èŒƒ

```python
# æ¨¡å—çº§æ–‡æ¡£å­—ç¬¦ä¸²ï¼ˆä¸­è‹±æ–‡å‡å¯ï¼‰
"""
Decoder Module - è¯‘ç å™¨æ¨¡å—

å®ç° RV32I æŒ‡ä»¤çš„è¯‘ç åŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š
- æŒ‡ä»¤è§£æ
- ç«‹å³æ•°æ‰©å±•
- æ§åˆ¶ä¿¡å·ç”Ÿæˆ
"""

# å‡½æ•°æ–‡æ¡£å­—ç¬¦ä¸²
def decode_instruction(inst: Bits) -> Record:
    """
    è§£ç  32 ä½ RISC-V æŒ‡ä»¤
    
    å‚æ•°:
        inst: 32 ä½æŒ‡ä»¤ç¼–ç 
        
    è¿”å›:
        åŒ…å«æ‰€æœ‰æ§åˆ¶ä¿¡å·çš„ Record å¯¹è±¡
    """
    pass

# è¡Œå†…æ³¨é‡Šï¼šè§£é‡Šå¤æ‚é€»è¾‘
# æ³¨æ„ï¼šRISC-V çš„ç«‹å³æ•°éœ€è¦ç¬¦å·æ‰©å±•
imm = sign_extend(raw_imm, 32)
```

#### 4. å¯¼å…¥è§„èŒƒ

```python
# æ ‡å‡†åº“å¯¼å…¥
import os
import sys

# ç¬¬ä¸‰æ–¹åº“å¯¼å…¥
from assassyn.frontend import *
from assassyn.backend import elaborate, config

# æœ¬åœ°å¯¼å…¥
from .control_signals import *
from .decoder import Decoder
```

### Assassyn ä»£ç è§„èŒƒ

#### 1. æ¨¡å—å®šä¹‰

```python
class MyModule(Module):
    def __init__(self):
        # å®šä¹‰ç«¯å£
        super().__init__(
            ports={
                'input_signal': Port(Bits(32)),
                'control': Port(my_ctrl_record),
            }
        )
        self.name = "MyModule"  # å¯é€‰ï¼šè®¾ç½®æ¨¡å—åç§°

    @module.combinational
    def build(self, downstream_module: Module, global_reg: Array):
        # è·å–è¾“å…¥
        input_signal, control = self.pop_all_ports(False)
        
        # å®ç°é€»è¾‘
        result = process(input_signal, control)
        
        # è°ƒç”¨ä¸‹æ¸¸æ¨¡å—
        downstream_module.async_called(data=result)
        
        # è¿”å›å¿…è¦çš„è¾“å‡º
        return result
```

#### 2. ç±»å‹ä½¿ç”¨

```python
# æ˜ç¡®ä½¿ç”¨ç±»å‹è½¬æ¢
alu_result = (a.bitcast(Int(32)) + b.bitcast(Int(32))).bitcast(Bits(32))

# é¿å…éšå¼ç±»å‹è½¬æ¢
# Bad:
result = a + b  # ä¸æ¸…æ¥šæ˜¯æœ‰ç¬¦å·è¿˜æ˜¯æ— ç¬¦å·

# Good:
result = (a.bitcast(UInt(32)) + b.bitcast(UInt(32))).bitcast(Bits(32))
```

#### 3. ä¿¡å·å‘½å

```python
# å¯„å­˜å™¨ï¼šä½¿ç”¨ _reg åç¼€
pc_reg = RegArray(Bits(32), 1)
data_reg = RegArray(Bits(32), 32)

# ç«‹å³æ•°ï¼šä½¿ç”¨ imm å‰ç¼€
imm_i = extract_imm_i(inst)
imm_s = extract_imm_s(inst)

# æ§åˆ¶ä¿¡å·ï¼šæè¿°æ€§åç§°
alu_op = extract_alu_op(inst)
mem_write_enable = control.mem_we
```

## æäº¤è§„èŒƒ

æˆ‘ä»¬ä½¿ç”¨ [Conventional Commits](https://www.conventionalcommits.org/) è§„èŒƒï¼š

### æäº¤æ¶ˆæ¯æ ¼å¼

```
<type>(<scope>): <subject>

<body>

<footer>
```

### Type ç±»å‹

- `feat`: æ–°åŠŸèƒ½
- `fix`: Bug ä¿®å¤
- `docs`: æ–‡æ¡£æ›´æ–°
- `style`: ä»£ç æ ¼å¼ï¼ˆä¸å½±å“ä»£ç å«ä¹‰ï¼‰
- `refactor`: é‡æ„ï¼ˆæ—¢ä¸æ˜¯æ–°åŠŸèƒ½ä¹Ÿä¸æ˜¯ä¿®å¤ï¼‰
- `perf`: æ€§èƒ½ä¼˜åŒ–
- `test`: æ·»åŠ æˆ–ä¿®æ”¹æµ‹è¯•
- `chore`: æ„å»ºè¿‡ç¨‹æˆ–è¾…åŠ©å·¥å…·çš„å˜åŠ¨

### Scope èŒƒå›´ï¼ˆå¯é€‰ï¼‰

- `fetch`: IF é˜¶æ®µ
- `decoder`: ID é˜¶æ®µ
- `execute`: EX é˜¶æ®µ
- `memory`: MEM é˜¶æ®µ
- `writeback`: WB é˜¶æ®µ
- `hazard`: å†’é™©å¤„ç†
- `test`: æµ‹è¯•ç›¸å…³
- `docs`: æ–‡æ¡£ç›¸å…³

### ç¤ºä¾‹

```bash
# æ·»åŠ æ–°åŠŸèƒ½
git commit -m "feat(decoder): add support for M extension instructions"

# ä¿®å¤ Bug
git commit -m "fix(execute): correct ALU shift operation logic"

# æ›´æ–°æ–‡æ¡£
git commit -m "docs: add installation guide for macOS"

# é‡æ„ä»£ç 
git commit -m "refactor(memory): simplify load/store logic"

# æ·»åŠ æµ‹è¯•
git commit -m "test(hazard): add tests for RAW hazard detection"
```

## æµ‹è¯•è¦æ±‚

### 1. æµ‹è¯•è¦†ç›–ç‡

- æ–°åŠŸèƒ½å¿…é¡»åŒ…å«æµ‹è¯•
- ç›®æ ‡è¦†ç›–ç‡ï¼šâ‰¥ 80%
- å…³é”®è·¯å¾„è¦†ç›–ç‡ï¼š100%

### 2. æµ‹è¯•æ–‡ä»¶ç»„ç»‡

```python
# tests/test_module_name.py
import pytest
from tests.common import run_test_module
from src.module_name import MyModule

def test_basic_functionality():
    """æµ‹è¯•åŸºæœ¬åŠŸèƒ½"""
    # è®¾ç½®æµ‹è¯•ç¯å¢ƒ
    sys = setup_test()
    
    # å®šä¹‰éªŒè¯å‡½æ•°
    def check(output):
        assert "expected" in output
    
    # è¿è¡Œæµ‹è¯•
    run_test_module(sys, check)

def test_edge_cases():
    """æµ‹è¯•è¾¹ç•Œæƒ…å†µ"""
    # ...
```

### 3. æµ‹è¯•å‘½å

```python
# æè¿°æ€§æµ‹è¯•åç§°
def test_decoder_handles_r_type_instruction():
    pass

def test_hazard_unit_detects_raw_dependency():
    pass

def test_memory_access_with_unaligned_address():
    pass
```

## æ–‡æ¡£è´¡çŒ®

### 1. æ–‡æ¡£ç±»å‹

- **ä»£ç æ³¨é‡Š**: è§£é‡Šå¤æ‚é€»è¾‘
- **æ¨¡å—æ–‡æ¡£**: `docs/Module/` ä¸­çš„è¯¦ç»†è®¾è®¡æ–‡æ¡£
- **æ•™ç¨‹**: ä½¿ç”¨æŒ‡å—å’Œç¤ºä¾‹
- **API æ–‡æ¡£**: å‡½æ•°å’Œç±»çš„è¯´æ˜

### 2. æ–‡æ¡£æ ¼å¼

- ä½¿ç”¨ Markdown æ ¼å¼
- æä¾›ä»£ç ç¤ºä¾‹
- åŒ…å«å›¾è¡¨ï¼ˆå¦‚éœ€è¦ï¼‰
- ä¸­è‹±æ–‡å‡å¯ï¼Œå»ºè®®ä¸­æ–‡

### 3. æ–‡æ¡£ç»“æ„

```markdown
# æ¨¡å—åç§°

## æ¦‚è¿°
ç®€è¦è¯´æ˜æ¨¡å—åŠŸèƒ½

## æ¥å£å®šä¹‰
åˆ—å‡ºè¾“å…¥è¾“å‡ºç«¯å£

## å®ç°ç»†èŠ‚
è¯¦ç»†è¯´æ˜å®ç°é€»è¾‘

## ä½¿ç”¨ç¤ºä¾‹
æä¾›ä»£ç ç¤ºä¾‹

## æ³¨æ„äº‹é¡¹
ç‰¹æ®Šæƒ…å†µå’Œé™åˆ¶
```

## é—®é¢˜æŠ¥å‘Š

### Bug æŠ¥å‘Š

ä½¿ç”¨ä»¥ä¸‹æ¨¡æ¿æŠ¥å‘Š Bugï¼š

```markdown
**Bug æè¿°**
ç®€è¦æè¿°é—®é¢˜

**å¤ç°æ­¥éª¤**
1. æ‰§è¡Œ '...'
2. è¿è¡Œ '...'
3. è§‚å¯Ÿé”™è¯¯ '...'

**æœŸæœ›è¡Œä¸º**
åº”è¯¥å‘ç”Ÿä»€ä¹ˆ

**å®é™…è¡Œä¸º**
å®é™…å‘ç”Ÿäº†ä»€ä¹ˆ

**ç¯å¢ƒä¿¡æ¯**
- OS: [e.g. Ubuntu 22.04]
- Python ç‰ˆæœ¬: [e.g. 3.11.0]
- Rust ç‰ˆæœ¬: [e.g. 1.70.0]

**é¢å¤–ä¿¡æ¯**
å…¶ä»–ç›¸å…³ä¿¡æ¯
```

### åŠŸèƒ½è¯·æ±‚

```markdown
**åŠŸèƒ½æè¿°**
æè¿°æ‚¨æƒ³è¦çš„åŠŸèƒ½

**ä½¿ç”¨åœºæ™¯**
ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªåŠŸèƒ½

**å»ºè®®å®ç°**
ï¼ˆå¯é€‰ï¼‰æ‚¨è®¤ä¸ºåº”è¯¥å¦‚ä½•å®ç°

**æ›¿ä»£æ–¹æ¡ˆ**
ï¼ˆå¯é€‰ï¼‰æ˜¯å¦è€ƒè™‘è¿‡å…¶ä»–æ–¹æ¡ˆ
```

## Pull Request æ¨¡æ¿

åˆ›å»º PR æ—¶ï¼Œè¯·åŒ…å«ä»¥ä¸‹ä¿¡æ¯ï¼š

```markdown
## æ›´æ”¹è¯´æ˜
ç®€è¦æè¿°æ­¤ PR çš„æ›´æ”¹

## æ›´æ”¹ç±»å‹
- [ ] æ–°åŠŸèƒ½
- [ ] Bug ä¿®å¤
- [ ] æ–‡æ¡£æ›´æ–°
- [ ] ä»£ç é‡æ„
- [ ] æ€§èƒ½ä¼˜åŒ–
- [ ] æµ‹è¯•æ”¹è¿›

## ç›¸å…³ Issue
Closes #issue_number

## æµ‹è¯•
- [ ] å·²æ·»åŠ æ–°æµ‹è¯•
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [ ] ä»£ç è¦†ç›–ç‡ç¬¦åˆè¦æ±‚

## æ£€æŸ¥æ¸…å•
- [ ] ä»£ç éµå¾ªé¡¹ç›®è§„èŒƒ
- [ ] å·²è¿è¡Œ `make format`
- [ ] å·²è¿è¡Œ `make lint`
- [ ] å·²æ›´æ–°ç›¸å…³æ–‡æ¡£
- [ ] æäº¤æ¶ˆæ¯éµå¾ªè§„èŒƒ

## é¢å¤–è¯´æ˜
å…¶ä»–éœ€è¦è¯´æ˜çš„ä¿¡æ¯
```

## è·å–å¸®åŠ©

å¦‚æœæ‚¨åœ¨è´¡çŒ®è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼š

1. æŸ¥çœ‹ [README.md](README.md) å’Œ [INSTALL.md](INSTALL.md)
2. æœç´¢ç°æœ‰çš„ [Issues](https://github.com/konpaku-ming/Assassyn-CPU/issues)
3. åœ¨ [Discussions](https://github.com/konpaku-ming/Assassyn-CPU/discussions) ä¸­æé—®
4. è”ç³»é¡¹ç›®ç»´æŠ¤è€…

## è‡´è°¢

æ„Ÿè°¢æ‰€æœ‰è´¡çŒ®è€…çš„ä»˜å‡ºï¼æ‚¨çš„è´¡çŒ®è®© Assassyn-CPU å˜å¾—æ›´å¥½ã€‚

---

å†æ¬¡æ„Ÿè°¢æ‚¨çš„è´¡çŒ®ï¼ğŸ‰
